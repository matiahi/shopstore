<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Products</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <!-- Logo / Brand -->
        <a class="navbar-brand" href="products.html">AccessoryShop</a>

        <!-- Mobile Toggler -->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#mainNavbar"
          aria-controls="mainNavbar"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navbar Links + Cart -->
        <div class="collapse navbar-collapse" id="mainNavbar">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="products.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin.html">My Account</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="orders.html">Orders</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contact.html">Contact Us</a>
            </li>
          </ul>

          <!-- Cart Button -->
          <button
            class="btn btn-outline-light position-relative"
            onclick="showCart()"
          >
            ðŸ›’ Cart
            <span
              id="cartCount"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
            >
              0
            </span>
          </button>
        </div>
      </div>
    </nav>

    <div class="bg-light">
      <h2 class="text-center mb-4">Product List</h2>
      <div id="productList" class="row row-col-1 row-cols-md-3 g-4">
        <!-- Products will be loaded here-->
      </div>
    </div>

    <!--Cart Modal-->
    <div
      class="modal fade"
      id="cartModal"
      tabindex="-1"
      aria-labelledby="cartModalLable"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cartModalLable">Your Shopping Cart</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="cartItemContainer">
            <!--Crt items will be injected here-->
          </div>
          <div class="modal-footer">
            <strong>Total: $<span id="cartTotal">0</span></strong>
            <button class="btn btn-success" disabled>Checkout</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      fetch("/api/products")
        .then((Response) => Response.json())
        .then((products) => {
          const list = document.getElementById("productList");
          products.forEach((product) => {
            const card = document.createElement("div");
            card.className = "col";
            card.innerHTML = `
                      <div class ="card h-100">
                          <img src="${product.imageUrl}" class="card-img-top" alt="${product.name}" style="object-fit: contain; height: 200px;">
                          <div class="card-body">
                              <h5 class="card-title">${product.name}</h5>
                              <p class="card-text">${product.description}</p>
                              <p class="card-text fw-bold text-success">$${product.price}</p>
                              <button class="btn btn-sm btn-primary mt-2" onclick="addToCart(${product.id}, '${product.name}', ${product.price}, '${product.imageUrl}')">Add to Cart</button>
                          </div>
                      </div>
                  `;
            list.appendChild(card);
          });
        })
        .catch((err) => {
          document.getElementById(
            "productList"
          ).innerHTML = `<div> class="text-danger">Failed to load products.</div>`;
        });

      function addToCart(id, name, price, imageUrl) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        const existing = cart.find((p) => p.id === id);
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ id, name, price, imageUrl, quantity: 1 });
        }
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
      }

      // Display cart content in a modal

      let cartModal = null;

      function showCart() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const container = document.getElementById("cartItemContainer");
        container.innerHTML = "";

        let total = 0;

        if (cart.length === 0) {
          container.innerHTML = "<p>Your cart is empty.</p>";
        } else {
          cart.forEach((item, index) => {
            total += item.price * item.quantity;

            const row = document.createElement("div");
            row.className =
              "d-flex justify-content-between align-items-center border-";
            row.innerHTML = `
                <div class = "d-flex align-items-center">
                  <img src = "${item.imageUrl}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: contain;" class = "me-3">
                  <div>
                    <h6 class="mb-0">${item.name}</h6>
                    <small>Price: $${item.price} * ${item.quantity}</small>
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">Remove</button>
                </div>
              `;
            container.appendChild(row);
          });
        }

        document.getElementById("cartTotal").textContent = total.toFixed(2);

        //create the modal only once
        if (!cartModal) {
          cartModal = new bootstrap.Modal(document.getElementById("cartModal"));
        }

        cartModal.show();
      }

      // Remove item from cart
      function removeFromCart(index) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        showCart(); //Redisplay the cart with the updated list
      }
      // update the count in the top badge

      function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("cartCount").textContent = count;
      }

      // Run on initial page load
      window.onload = updateCartCount;

      document
        .getElementById("cartModal")
        .addEventListener("hidden.bs.modal", function () {
          document
            .querySelectorAll(".modal-backdrop")
            .forEach((el) => el.remove());
          document.body.classList.remove("modal-open");
          document.body.style = "";
        });

      const checkoutBtn = document.getElementById("checkoutBtn");
      checkoutBtn.disabled = cart.length === 0;

      checkoutBtn.addEventListener("click", () => {
        window.location.href = "checkout.html";
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
